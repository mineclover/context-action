name: Glossary Mapping Sync

on:
  push:
    branches: [ main ]
    paths:
      - 'example/src/**/*.{ts,tsx,js,jsx}'
      - 'packages/*/src/**/*.{ts,tsx,js,jsx}'
      - 'docs/glossary/**/*.md'
      - 'docs/tools/**/*.js'
  pull_request:
    branches: [ main ]
    paths:
      - 'example/src/**/*.{ts,tsx,js,jsx}'
      - 'packages/*/src/**/*.{ts,tsx,js,jsx}'
      - 'docs/glossary/**/*.md'
      - 'docs/tools/**/*.js'

jobs:
  glossary-sync:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install root dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build glossary package
        run: pnpm --filter @context-action/glossary build
      
      - name: Scan code for glossary tags
        id: scan
        run: |
          echo "Starting glossary scan with new API..."
          pnpm glossary:scan
          echo "scan_completed=true" >> $GITHUB_OUTPUT
      
      - name: Generate implementation documents
        id: generate
        if: steps.scan.outputs.scan_completed == 'true'
        run: |
          cd docs/tools
          echo "Generating implementation documents..."
          node mapping-generator.js
          echo "generation_completed=true" >> $GITHUB_OUTPUT
      
      - name: Validate mappings
        id: validate
        if: steps.generate.outputs.generation_completed == 'true'
        run: |
          echo "Validating glossary mappings with new API..."
          pnpm glossary:validate
          echo "validation_completed=true" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Check for changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            if git diff --quiet docs/implementations/; then
              echo "changes_detected=false" >> $GITHUB_OUTPUT
              echo "No changes detected in implementation docs"
            else
              echo "changes_detected=true" >> $GITHUB_OUTPUT
              echo "Changes detected in implementation docs"
            fi
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit updated mappings
        if: github.event_name == 'push' && steps.changes.outputs.changes_detected == 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add docs/implementations/
          
          # Ïª§Î∞ã Î©îÏãúÏßÄ ÏÉùÏÑ±
          CHANGED_FILES=$(git diff --cached --name-only | wc -l)
          COMMIT_MSG="ü§ñ Auto-update glossary mappings
          
          - Updated $CHANGED_FILES implementation files
          - Triggered by: ${{ github.event.head_commit.message }}
          - Commit: ${{ github.sha }}
          
          Generated by GitHub Actions"
          
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
      
      - name: Push changes
        if: github.event_name == 'push' && steps.changes.outputs.changes_detected == 'true'
        run: |
          git push origin main
      
      - name: Create PR comment with validation results
        if: github.event_name == 'pull_request' && steps.validate.outputs.validation_completed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Í≤ÄÏ¶ù Í≤∞Í≥º ÏùΩÍ∏∞
            const reportPath = 'docs/implementations/_data/validation-report.json';
            let report = { summary: { errors: 0, warnings: 0 } };
            
            try {
              if (fs.existsSync(reportPath)) {
                report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              }
            } catch (error) {
              console.log('Could not read validation report:', error.message);
            }
            
            const { errors, warnings, implementationRate } = report.summary;
            const success = errors === 0;
            
            // ÎåìÍ∏Ä ÎÇ¥Ïö© ÏÉùÏÑ±
            const status = success ? '‚úÖ' : '‚ùå';
            const statusText = success ? 'Passed' : 'Failed';
            
            let comment = `## ${status} Glossary Mapping Validation ${statusText}
            
            ### üìä Summary
            - **Errors**: ${errors}
            - **Warnings**: ${warnings}
            - **Implementation Rate**: ${implementationRate}%
            
            `;
            
            if (errors > 0) {
              comment += `### ‚ùå Errors Found
              
              Please fix the following issues before merging:
              
              `;
              
              if (report.details && report.details.errors) {
                const errorsByType = {};
                report.details.errors.forEach(error => {
                  if (!errorsByType[error.type]) {
                    errorsByType[error.type] = [];
                  }
                  errorsByType[error.type].push(error);
                });
                
                for (const [type, typeErrors] of Object.entries(errorsByType)) {
                  comment += `**${type}**:\n`;
                  typeErrors.slice(0, 5).forEach(error => {
                    comment += `- ${error.file}:${error.line || '?'} - ${error.message}\n`;
                  });
                  if (typeErrors.length > 5) {
                    comment += `- ... and ${typeErrors.length - 5} more\n`;
                  }
                  comment += '\n';
                }
              }
            }
            
            if (warnings > 0) {
              comment += `### ‚ö†Ô∏è Warnings (${warnings})
              
              Consider addressing these warnings to improve documentation quality.
              
              `;
            }
            
            comment += `### üîó Resources
            - [Tagging Guide](https://github.com/${{ github.repository }}/blob/main/docs/GLOSSARY_TAGGING_GUIDE.md)
            - [Mapping System](https://github.com/${{ github.repository }}/blob/main/docs/GLOSSARY_MAPPING_SYSTEM.md)
            
            <details>
            <summary>Full validation report</summary>
            
            \`\`\`json
            ${JSON.stringify(report, null, 2)}
            \`\`\`
            
            </details>`;
            
            // Í∏∞Ï°¥ ÎåìÍ∏Ä Ï∞æÍ∏∞
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Glossary Mapping Validation')
            );
            
            if (botComment) {
              // Í∏∞Ï°¥ ÎåìÍ∏Ä ÏóÖÎç∞Ïù¥Ìä∏
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // ÏÉà ÎåìÍ∏Ä ÏÉùÏÑ±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
      
      - name: Upload validation artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: glossary-validation-results
          path: |
            docs/implementations/_data/mappings.json
            docs/implementations/_data/validation-report.json
            docs/implementations/
          retention-days: 30
      
      - name: Set job status
        if: always()
        run: |
          if [ "${{ steps.validate.outcome }}" = "failure" ]; then
            echo "‚ùå Validation failed with errors"
            exit 1
          elif [ "${{ steps.validate.outcome }}" = "success" ]; then
            echo "‚úÖ Validation completed successfully"
          else
            echo "‚ö†Ô∏è Validation completed with warnings"
          fi