#!/bin/sh

# Get list of modified markdown files from the last commit
MODIFIED_DOCS=$(git diff --name-only HEAD~1 HEAD | grep -E '^docs/(en|ko)/.*\.md$' | grep -v llms/ || true)

# Check if llmsData directory exists and has been initialized
if [ -d "llmsData" ] && [ -n "$MODIFIED_DOCS" ]; then
  echo "üìù Documentation files were modified in last commit. Updating LLM work status..."
  
  # Debug: Show detected files
  echo "üîç Detected modified files:"
  echo "$MODIFIED_DOCS" | sed 's/^/  - /'
  
  # Run the llms-generator sync-docs command with enhanced error handling
  if node packages/llms-generator/dist/cli/index.js sync-docs --changed-files "$MODIFIED_DOCS" --quiet; then
    echo "‚úÖ Sync-docs completed successfully"
  else
    echo "‚ö†Ô∏è  Sync-docs encountered an issue, but continuing..."
  fi
  
  # Check if any files were actually updated
  LLMS_CHANGES=$(git status --porcelain llmsData/ 2>/dev/null || true)
  
  if [ -n "$LLMS_CHANGES" ]; then
    echo "üìã LLM work status files updated:"
    echo "$LLMS_CHANGES" | sed 's/^/  /'
    echo "‚ÑπÔ∏è  Files are ready to be committed manually when desired"
    echo "üí° To commit these changes, run: git add llmsData/ && git commit -m \"chore(llms): update documentation status\""
  else
    echo "‚ÑπÔ∏è  No LLM updates needed"
  fi
elif [ -n "$MODIFIED_DOCS" ] && [ ! -d "llmsData" ]; then
  echo "‚ÑπÔ∏è  Documentation files modified, but llmsData/ not initialized. Run 'pnpm llms:init' to enable LLM sync."
fi