#!/bin/bash

# Work Queue ê°„í¸ ë˜í¼ ìŠ¤í¬ë¦½íŠ¸
# Usage: ./wq [command] [options]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WQ_CLI="$SCRIPT_DIR/work-queue-cli.cjs"

# ë””í´íŠ¸ ì–¸ì–´ ì„¤ì •
DEFAULT_LANG="${WQ_DEFAULT_LANG:-en}"

case "$1" in
  "")
    # ì¸ì ì—†ìŒ - ë„ì›€ë§ í‘œì‹œ
    node "$WQ_CLI"
    ;;
  
  "n"|"next")
    # ë‹¤ìŒ ì‘ì—… ëŒ€ìƒ
    LANG="${2:-$DEFAULT_LANG}"
    echo "ğŸ” Getting next work target for $LANG..."
    node "$WQ_CLI" next "$LANG"
    ;;
  
  "s"|"status")
    # ìƒíƒœ í™•ì¸
    LANG="${2:-$DEFAULT_LANG}"
    node "$WQ_CLI" status "$LANG"
    ;;
  
  "l"|"list")
    # ëª©ë¡ ë³´ê¸°
    LANG="${2:-$DEFAULT_LANG}"
    SHOW_ALL=""
    if [ "$3" = "--all" ] || [ "$2" = "--all" ]; then
      SHOW_ALL="--all"
      if [ "$2" = "--all" ]; then
        LANG="$DEFAULT_LANG"
      fi
    fi
    node "$WQ_CLI" list "$LANG" $SHOW_ALL
    ;;
  
  "c"|"complete")
    # ì‘ì—… ì™„ë£Œ
    if [ -z "$2" ]; then
      echo "âŒ Target ID required"
      echo "Usage: ./wq complete <target-id> [language]"
      exit 1
    fi
    LANG="${3:-$DEFAULT_LANG}"
    node "$WQ_CLI" complete "$2" "$LANG"
    echo "âœ¨ Use './wq n $LANG' to get next work target"
    ;;
  
  "skip")
    # ì‘ì—… ê±´ë„ˆë›°ê¸°
    if [ -z "$2" ]; then
      echo "âŒ Target ID required"
      echo "Usage: ./wq skip <target-id> [language]"
      exit 1
    fi
    LANG="${3:-$DEFAULT_LANG}"
    node "$WQ_CLI" skip "$2" "$LANG"
    echo "âœ¨ Use './wq n $LANG' to get next work target"
    ;;
  
  "r"|"reset")
    # ë¦¬ì…‹
    LANG="$2"
    if [ -n "$LANG" ]; then
      echo "ğŸ”„ Resetting work queue for $LANG..."
    else
      echo "ğŸ”„ Resetting entire work queue..."
    fi
    node "$WQ_CLI" reset "$LANG"
    ;;
  
  "work")
    # ì‘ì—… ëª¨ë“œ - í˜„ì¬ ì‘ì—… í‘œì‹œí•˜ê³  ì—ë””í„° ì—´ê¸°
    LANG="${2:-$DEFAULT_LANG}"
    TARGET_INFO=$(node "$WQ_CLI" next "$LANG" 2>/dev/null)
    
    if echo "$TARGET_INFO" | grep -q "All work completed"; then
      echo "ğŸ‰ All work completed!"
      exit 0
    fi
    
    # priority.json íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ
    PRIORITY_FILE=$(echo "$TARGET_INFO" | grep "ğŸ“ Priority File:" | sed 's/ğŸ“ Priority File: //')
    
    if [ -n "$PRIORITY_FILE" ] && [ -f "$PRIORITY_FILE" ]; then
      echo "ğŸ“ Opening priority file in editor..."
      ${EDITOR:-code} "$PRIORITY_FILE"
    else
      echo "âŒ Could not find priority file"
    fi
    ;;
  
  "quick")
    # ë¹ ë¥¸ ìƒíƒœ ì²´í¬
    echo "ğŸ“Š Quick Status:"
    for lang in en ko; do
      if [ -d "$SCRIPT_DIR/data/$lang" ]; then
        SUMMARY=$(node "$WQ_CLI" status "$lang" 2>/dev/null | grep -E "(Completed|Remaining)" | head -2)
        echo "  $lang: $(echo "$SUMMARY" | grep Completed | sed 's/.*Completed: //' | sed 's/ (.*//')/$(echo "$SUMMARY" | grep Remaining | sed 's/.*Remaining: //' | sed 's/ (.*//')"
      fi
    done
    ;;
  
  "check"|"check-dups")
    # ì¤‘ë³µ ê²€ì‚¬
    LANG="${2:-$DEFAULT_LANG}"
    echo "ğŸ” Checking duplicates for $LANG..."
    node "$WQ_CLI" check-duplicates "$LANG"
    ;;
  
  "resolve"|"resolve-dups")
    # ì¤‘ë³µ í•´ê²°
    LANG="$2"
    DRY_RUN=""
    STRATEGY=""
    
    # ì˜µì…˜ íŒŒì‹±
    for arg in "${@:2}"; do
      case "$arg" in
        "--dry-run")
          DRY_RUN="--dry-run"
          ;;
        "--strategy="*)
          STRATEGY="$arg"
          ;;
        *)
          if [ -z "$LANG" ] && [[ ! "$arg" =~ ^-- ]]; then
            LANG="$arg"
          fi
          ;;
      esac
    done
    
    LANG="${LANG:-$DEFAULT_LANG}"
    
    if [ -n "$DRY_RUN" ]; then
      echo "ğŸ” Analyzing duplicate resolution for $LANG (dry run)..."
    else
      echo "ğŸ”§ Resolving duplicates for $LANG..."
    fi
    
    node "$WQ_CLI" resolve-duplicates $LANG $DRY_RUN $STRATEGY
    ;;
  
  "ambiguity"|"check-ambiguity")
    # ëª¨í˜¸ì„± ìœ„í—˜ ë¶„ì„
    LANG="${2:-$DEFAULT_LANG}"
    echo "ğŸ” Analyzing ambiguity risks for $LANG..."
    node "$WQ_CLI" check-ambiguity "$LANG"
    ;;
  
  "migrate"|"migrate-hierarchical")
    # ê³„ì¸µì  ID ë§ˆì´ê·¸ë ˆì´ì…˜
    LANG="$2"
    DRY_RUN=""
    CATEGORY=""
    
    # ì˜µì…˜ íŒŒì‹±
    for arg in "${@:2}"; do
      case "$arg" in
        "--dry-run")
          DRY_RUN="--dry-run"
          ;;
        "--category="*)
          CATEGORY="$arg"
          ;;
        *)
          if [ -z "$LANG" ] && [[ ! "$arg" =~ ^-- ]]; then
            LANG="$arg"
          fi
          ;;
      esac
    done
    
    LANG="${LANG:-$DEFAULT_LANG}"
    
    if [ -n "$DRY_RUN" ]; then
      echo "ğŸ” Analyzing hierarchical migration for $LANG (dry run)..."
    else
      echo "ğŸ”„ Migrating to hierarchical IDs for $LANG..."
    fi
    
    node "$WQ_CLI" migrate-hierarchical $LANG $DRY_RUN $CATEGORY
    ;;
  
  *)
    # ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´
    echo "âŒ Unknown command: $1"
    echo ""
    echo "ğŸ“‹ Work Queue Shortcuts:"
    echo "  ./wq                    Show help"
    echo "  ./wq n [lang]          Next work target"
    echo "  ./wq s [lang]          Status summary"
    echo "  ./wq l [lang] [--all]  List targets"
    echo "  ./wq c <id> [lang]     Complete work"
    echo "  ./wq skip <id> [lang]  Skip work"
    echo "  ./wq r [lang]          Reset queue"
    echo "  ./wq work [lang]       Work mode (open editor)"
    echo "  ./wq quick             Quick status check"
    echo "  ./wq check [lang]      Check for duplicates"
    echo "  ./wq resolve [lang] [opts]  Resolve duplicates"
    echo "  ./wq ambiguity [lang]  Check ambiguity risks"
    echo "  ./wq migrate [lang] [opts]  Migrate to hierarchical IDs"
    echo ""
    echo "Advanced Operations:"
    echo "  ./wq resolve --dry-run      Analyze without changes"
    echo "  ./wq migrate --dry-run --category=api  Analyze API migration"
    echo "  ./wq resolve --strategy=hierarchical-separator"
    echo ""
    echo "Default language: $DEFAULT_LANG (set WQ_DEFAULT_LANG to change)"
    exit 1
    ;;
esac